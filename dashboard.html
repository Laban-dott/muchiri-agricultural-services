<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - Muchiri Services</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="dashboard-fixes.css">
    
    <!-- Firebase Scripts -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getDatabase, ref, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        
        // Firebase configuration - Real config from Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyBnH0Hvu1gMGCsX6A7N7kZPlGx5g8c8BL0",
            authDomain: "muchiri-services.firebaseapp.com",
            databaseURL: "https://muchiri-services-default-rtdb.firebaseio.com/",
            projectId: "muchiri-services",
            storageBucket: "muchiri-services.appspot.com",
            messagingSenderId: "295464346483",
            appId: "1:295464346483:web:7e8c8d4c6e5d4e3c2b1a90"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase functions available globally
        window.firebaseDB = { database, ref, onValue, update };
    </script>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="page">
        <div class="login-container">
            <div class="login-header">
                <h1>üöú Driver Login</h1>
                <p>Access your service dashboard</p>
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="input-group">
                    <input type="text" id="username" placeholder="Username" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Password" required>
                </div>
                <button type="submit" class="login-btn">Login</button>
            </form>
            
            <div class="login-footer">
                <button onclick="goHome()" class="back-home-btn">‚Üê Back to Home</button>
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page hidden">
        <div class="dashboard-container">
            <!-- Header -->
            <header class="dashboard-header">
                <div class="header-content">
                    <h1>Driver Dashboard</h1>
                    <button onclick="logout()" class="logout-btn">Logout</button>
                </div>
                <div class="stats-summary">
                    <div class="stat-item">
                        <span class="stat-number" id="totalBookings">0</span>
                        <span class="stat-label">Total Bookings</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="completedBookings">0</span>
                        <span class="stat-label">Completed</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="pendingBookings">0</span>
                        <span class="stat-label">Pending</span>
                    </div>
                </div>
            </header>

            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="showTab('pending')">
                    Pending <span id="pendingCount" class="count-badge">0</span>
                </button>
                <button class="tab-btn" onclick="showTab('completed')">
                    Completed <span id="completedCount" class="count-badge">0</span>
                </button>
                <button class="tab-btn" onclick="showTab('all')">
                    All Bookings <span id="allCount" class="count-badge">0</span>
                </button>
            </div>

            <!-- Bookings Content -->
            <div class="bookings-content">
                <!-- Pending Bookings -->
                <div id="pendingTab" class="tab-content active">
                    <div class="section-header">
                        <h2>üìã Pending Services</h2>
                        <button onclick="refreshBookings()" class="refresh-btn">üîÑ Refresh</button>
                    </div>
                    <div id="pendingBookings" class="bookings-list">
                        <!-- Pending bookings will be loaded here -->
                    </div>
                </div>

                <!-- Completed Bookings -->
                <div id="completedTab" class="tab-content">
                    <div class="section-header">
                        <h2>‚úÖ Completed Services</h2>
                        <button onclick="refreshBookings()" class="refresh-btn">üîÑ Refresh</button>
                    </div>
                    <div id="completedBookings" class="bookings-list">
                        <!-- Completed bookings will be loaded here -->
                    </div>
                </div>

                <!-- All Bookings -->
                <div id="allTab" class="tab-content">
                    <div class="section-header">
                        <h2>üìä All Services</h2>
                        <button onclick="refreshBookings()" class="refresh-btn">üîÑ Refresh</button>
                    </div>
                    <div id="allBookings" class="bookings-list">
                        <!-- All bookings will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global bookings data
        let bookingsData = [];

        // Load bookings from Firebase or localStorage
        function loadBookingsData() {
            if (window.firebaseDB) {
                // Load from Firebase
                const bookingsRef = window.firebaseDB.ref(window.firebaseDB.database, 'bookings');
                window.firebaseDB.onValue(bookingsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Convert Firebase data to array format
                        bookingsData = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        }));
                        console.log('Loaded bookings from Firebase:', bookingsData);
                    } else {
                        bookingsData = [];
                        console.log('No bookings found in Firebase');
                    }
                    updateStats();
                    renderBookings();
                }, (error) => {
                    console.error('Error loading from Firebase:', error);
                    loadFromLocalStorage();
                });
            } else {
                loadFromLocalStorage();
            }
        }

        // Fallback to localStorage
        function loadFromLocalStorage() {
            const storedBookings = localStorage.getItem('muchiri_bookings');
            if (storedBookings) {
                bookingsData = JSON.parse(storedBookings);
                console.log('Loaded bookings from localStorage:', bookingsData);
            } else {
                // Use sample data if no stored data
                bookingsData = [
                    {
                        id: 'sample1',
                        service: 'Rotavation',
                        customer: 'John Kamau',
                        phone: '0712345678',
                        section: 'Kraba',
                        unit: 'K1',
                        quantity: '2 acres',
                        date: '2025-08-29',
                        amount: 'KSH 10,000',
                        status: 'pending',
                        createdAt: '2025-08-28'
                    }
                ];
                console.log('Using sample data');
            }
            updateStats();
            renderBookings();
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Simple authentication (in real app, use proper authentication)
            if (username === 'muchiri' && password === '54321') {
                showPage('dashboardPage');
                loadDashboard();
            } else {
                alert('Invalid username or password');
            }
        });

        // Page navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
        }

        function goHome() {
            window.location.href = 'home.html';
        }

        function logout() {
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showPage('loginPage');
        }

        // Tab functionality
        function showTab(tabName) {
            // Remove active from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Add active to selected tab
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Load dashboard data
        function loadDashboard() {
            loadBookingsData(); // This will call updateStats() and renderBookings()
        }

        function updateStats() {
            const total = bookingsData.length;
            const completed = bookingsData.filter(b => b.status === 'completed').length;
            const pending = bookingsData.filter(b => b.status === 'pending').length;
            
            document.getElementById('totalBookings').textContent = total;
            document.getElementById('completedBookings').textContent = completed;
            document.getElementById('pendingBookings').textContent = pending;
            
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('allCount').textContent = total;
        }

        function renderBookings() {
            const pendingBookings = bookingsData.filter(b => b.status === 'pending');
            const completedBookings = bookingsData.filter(b => b.status === 'completed');
            
            renderBookingsList('pendingBookings', pendingBookings);
            renderBookingsList('completedBookings', completedBookings);
            renderBookingsList('allBookings', bookingsData);
        }

        function renderBookingsList(containerId, bookings) {
            const container = document.getElementById(containerId);
            
            if (bookings.length === 0) {
                container.innerHTML = `
                    <div class="no-bookings">
                        <div class="no-bookings-icon">üìù</div>
                        <p>No bookings found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = bookings.map(booking => `
                <div class="booking-card ${booking.status}">
                    <div class="booking-header">
                        <div class="service-info">
                            <h3>${getServiceIcon(booking.service)} ${booking.service}</h3>
                            <span class="status-badge ${booking.status}">${booking.status.toUpperCase()}</span>
                        </div>
                        <div class="booking-amount">${booking.amount}</div>
                    </div>
                    
                    <div class="customer-info">
                        <div class="info-row">
                            <span class="label">Customer:</span>
                            <span class="value">${booking.customer}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Phone:</span>
                            <span class="value">${booking.phone}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Location:</span>
                            <span class="value">${booking.section} - ${booking.unit}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Quantity:</span>
                            <span class="value">${booking.quantity}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Date:</span>
                            <span class="value">${formatDate(booking.date)}</span>
                        </div>
                    </div>
                    
                    ${booking.status === 'pending' ? `
                        <div class="booking-actions">
                            <button onclick="markCompleted(${booking.id})" class="complete-btn">
                                ‚úÖ Mark Complete
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function getServiceIcon(service) {
            switch (service) {
                case 'Rotavation': return 'üöú';
                case 'Transport': return 'üöö';
                case 'Harvesting': return 'üåæ';
                default: return 'üîß';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function markCompleted(bookingId) {
            const booking = bookingsData.find(b => b.id === bookingId);
            if (booking && booking.status === 'pending') {
                // Add visual feedback immediately
                const button = document.querySelector(`button[onclick="markCompleted('${bookingId}')"]`);
                if (button) {
                    button.innerHTML = '‚è≥ Processing...';
                    button.disabled = true;
                    button.style.opacity = '0.7';
                    button.style.cursor = 'not-allowed';
                }

                // Update booking status
                booking.status = 'completed';
                booking.completedAt = new Date().toISOString();
                
                // Update in Firebase if available
                if (window.firebaseDB && typeof bookingId === 'string' && bookingId !== 'sample1') {
                    const bookingRef = window.firebaseDB.ref(window.firebaseDB.database, `bookings/${bookingId}`);
                    window.firebaseDB.update(bookingRef, { 
                        status: 'completed',
                        completedAt: booking.completedAt
                    })
                    .then(() => {
                        console.log('Status updated in Firebase');
                        setTimeout(() => refreshDashboardUI(bookingId), 500);
                    })
                    .catch((error) => {
                        console.error('Error updating Firebase:', error);
                        setTimeout(() => refreshDashboardUI(bookingId), 500);
                    });
                } else {
                    // Update localStorage if Firebase not available
                    const storedBookings = JSON.parse(localStorage.getItem('muchiri_bookings') || '[]');
                    const bookingIndex = storedBookings.findIndex(b => b.id === bookingId);
                    if (bookingIndex !== -1) {
                        storedBookings[bookingIndex].status = 'completed';
                        storedBookings[bookingIndex].completedAt = booking.completedAt;
                        localStorage.setItem('muchiri_bookings', JSON.stringify(storedBookings));
                    }
                    setTimeout(() => refreshDashboardUI(bookingId), 500);
                }
            }
        }

        // Enhanced UI refresh function
        function refreshDashboardUI(completedBookingId) {
            // Update stats first
            updateStats();
            
            // Re-render all booking lists
            renderBookings();
            
            // Show success message with completed booking info
            const completedBooking = bookingsData.find(b => b.id === completedBookingId);
            if (completedBooking) {
                showSuccessMessage(`‚úÖ ${completedBooking.service} service completed for ${completedBooking.customer}!`);
            } else {
                showSuccessMessage('‚úÖ Service marked as completed!');
            }
            
            // If user is currently viewing pending tab, they'll see the item disappear
            // If viewing completed tab, they'll see the item appear with COMPLETED badge
            // If viewing all tab, they'll see the status change from PENDING to COMPLETED
        }

        // Enhanced success message function
        function showSuccessMessage(message) {
            // Remove any existing success message
            const existingMsg = document.querySelector('.success-message');
            if (existingMsg) {
                existingMsg.remove();
            }

            const successMsg = document.createElement('div');
            successMsg.className = 'success-message';
            successMsg.textContent = message;
            successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 15px 25px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3);
                z-index: 1000;
                font-weight: 500;
                font-size: 0.95rem;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            document.body.appendChild(successMsg);
            
            // Animate in
            setTimeout(() => {
                successMsg.style.transform = 'translateX(0)';
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                successMsg.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(successMsg)) {
                        document.body.removeChild(successMsg);
                    }
                }, 300);
            }, 3000);
        }

        function refreshBookings() {
            // Refresh data from Firebase or localStorage
            const refreshBtn = event.target;
            refreshBtn.textContent = 'üîÑ Refreshing...';
            refreshBtn.disabled = true;
            
            setTimeout(() => {
                loadBookingsData(); // Reload fresh data
                refreshBtn.textContent = 'üîÑ Refresh';
                refreshBtn.disabled = false;
            }, 1000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            showPage('loginPage');
        });
    </script>
</body>
</html>
