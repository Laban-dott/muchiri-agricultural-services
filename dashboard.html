<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - Muchiri Services</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="dashboard-fixes.css">
    
    <!-- Firebase Scripts -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getDatabase, ref, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';
        
        // Firebase configuration - Real config from Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyBnH0Hvu1gMGCsX6A7N7kZPlGx5g8c8BL0",
            authDomain: "muchiri-services.firebaseapp.com",
            databaseURL: "https://muchiri-services-default-rtdb.firebaseio.com/",
            projectId: "muchiri-services",
            storageBucket: "muchiri-services.appspot.com",
            messagingSenderId: "295464346483",
            appId: "1:295464346483:web:7e8c8d4c6e5d4e3c2b1a90"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase functions available globally
        window.firebaseDB = { database, ref, onValue, update };
    </script>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="page">
        <div class="login-container">
            <div class="login-header">
                <h1>üöú Driver Login</h1>
                <p>Access your service dashboard</p>
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="input-group">
                    <input type="text" id="username" placeholder="Username" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Password" required>
                </div>
                <button type="submit" class="login-btn">Login</button>
            </form>
            
            <div class="login-footer">
                <button onclick="goHome()" class="back-home-btn">‚Üê Back to Home</button>
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page hidden">
        <div class="dashboard-container">
            <!-- Header -->
            <header class="dashboard-header">
                <div class="header-content">
                    <h1>Driver Dashboard</h1>
                    <button onclick="logout()" class="logout-btn">Logout</button>
                </div>
                <div class="stats-summary">
                    <div class="stat-item">
                        <span class="stat-number" id="totalBookings">0</span>
                        <span class="stat-label">Total Bookings</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="completedBookings">0</span>
                        <span class="stat-label">Completed</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="pendingBookings">0</span>
                        <span class="stat-label">Pending</span>
                    </div>
                </div>
            </header>

            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="showTab('pending')">
                    Pending <span id="pendingCount" class="count-badge">0</span>
                </button>
                <button class="tab-btn" onclick="showTab('completed')">
                    Completed <span id="completedCount" class="count-badge">0</span>
                </button>
                <button class="tab-btn" onclick="showTab('all')">
                    All Bookings <span id="allCount" class="count-badge">0</span>
                </button>
            </div>

            <!-- Bookings Content -->
            <div class="bookings-content">
                <!-- Pending Bookings -->
                <div id="pendingTab" class="tab-content active">
                    <div class="section-header">
                        <h2>üìã Pending Services</h2>
                        <div class="section-actions">
                            <div class="bulk-select-controls">
                                <button onclick="selectAllInSection('pendingBookings')" class="select-all-btn">Select All</button>
                                <button onclick="clearSelectionInSection('pendingBookings')" class="clear-selection-btn">Clear</button>
                                <button onclick="deleteSelectedBookings('pendingBookings')" class="delete-selected-btn" disabled>Delete Selected</button>
                            </div>
                            <button onclick="refreshBookings()" class="refresh-btn">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div id="pendingBookings" class="bookings-list">
                        <!-- Pending bookings will be loaded here -->
                    </div>
                </div>

                <!-- Completed Bookings -->
                <div id="completedTab" class="tab-content">
                    <div class="section-header">
                        <h2>‚úÖ Completed Services</h2>
                        <div class="section-actions">
                            <div class="bulk-select-controls">
                                <button onclick="selectAllInSection('completedBookings')" class="select-all-btn">Select All</button>
                                <button onclick="clearSelectionInSection('completedBookings')" class="clear-selection-btn">Clear</button>
                                <button onclick="deleteSelectedBookings('completedBookings')" class="delete-selected-btn" disabled>Delete Selected</button>
                            </div>
                            <button onclick="refreshBookings()" class="refresh-btn">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div id="completedBookings" class="bookings-list">
                        <!-- Completed bookings will be loaded here -->
                    </div>
                </div>

                <!-- All Bookings -->
                <div id="allTab" class="tab-content">
                    <div class="section-header">
                        <h2>üìä All Services</h2>
                        <div class="section-actions">
                            <div class="bulk-select-controls">
                                <button onclick="selectAllInSection('allBookings')" class="select-all-btn">Select All</button>
                                <button onclick="clearSelectionInSection('allBookings')" class="clear-selection-btn">Clear</button>
                                <button onclick="deleteSelectedBookings('allBookings')" class="delete-selected-btn" disabled>Delete Selected</button>
                            </div>
                            <button onclick="refreshBookings()" class="refresh-btn">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div id="allBookings" class="bookings-list">
                        <!-- All bookings will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global bookings data
        let bookingsData = [];

        // Load bookings from Firebase or localStorage
        function loadBookingsData() {
            if (window.firebaseDB) {
                // Load from Firebase
                const bookingsRef = window.firebaseDB.ref(window.firebaseDB.database, 'bookings');
                window.firebaseDB.onValue(bookingsRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Convert Firebase data to array format
                        bookingsData = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        }));
                        console.log('Loaded bookings from Firebase:', bookingsData);
                    } else {
                        bookingsData = [];
                        console.log('No bookings found in Firebase');
                    }
                    updateStats();
                    renderBookings();
                }, (error) => {
                    console.error('Error loading from Firebase:', error);
                    loadFromLocalStorage();
                });
            } else {
                loadFromLocalStorage();
            }
        }

        // Fallback to localStorage
        function loadFromLocalStorage() {
            const storedBookings = localStorage.getItem('muchiri_bookings');
            if (storedBookings) {
                bookingsData = JSON.parse(storedBookings);
                console.log('Loaded bookings from localStorage:', bookingsData);
            } else {
                // Use sample data if no stored data
                bookingsData = [
                    {
                        id: 'sample1',
                        service: 'Rotavation',
                        customer: 'John Kamau',
                        phone: '0712345678',
                        section: 'Kraba',
                        unit: 'K1',
                        quantity: '2 acres',
                        date: '2025-08-29',
                        amount: 'KSH 10,000',
                        status: 'pending',
                        createdAt: '2025-08-28'
                    }
                ];
                console.log('Using sample data');
            }
            updateStats();
            renderBookings();
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Simple authentication (in real app, use proper authentication)
            if (username === 'muchiri' && password === '54321') {
                showPage('dashboardPage');
                loadDashboard();
            } else {
                alert('Invalid username or password');
            }
        });

        // Page navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
        }

        function goHome() {
            window.location.href = 'home.html';
        }

        function logout() {
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showPage('loginPage');
        }

        // Tab functionality
        function showTab(tabName) {
            // Remove active from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Add active to selected tab
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Load dashboard data
        function loadDashboard() {
            loadBookingsData(); // This will call updateStats() and renderBookings()
        }

        function updateStats() {
            const total = bookingsData.length;
            const completed = bookingsData.filter(b => b.status === 'completed').length;
            const pending = bookingsData.filter(b => b.status === 'pending').length;
            
            document.getElementById('totalBookings').textContent = total;
            document.getElementById('completedBookings').textContent = completed;
            document.getElementById('pendingBookings').textContent = pending;
            
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('allCount').textContent = total;
        }

        function renderBookings() {
            const pendingBookings = bookingsData.filter(b => b.status === 'pending');
            const completedBookings = bookingsData.filter(b => b.status === 'completed');
            
            renderBookingsList('pendingBookings', pendingBookings);
            renderBookingsList('completedBookings', completedBookings);
            renderBookingsList('allBookings', bookingsData);
        }

        function renderBookingsList(containerId, bookings) {
            const container = document.getElementById(containerId);
            
            if (bookings.length === 0) {
                container.innerHTML = `
                    <div class="no-bookings">
                        <div class="no-bookings-icon">üìù</div>
                        <p>No bookings found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = bookings.map(booking => `
                <div class="booking-card ${booking.status}">
                    <div class="booking-header">
                        <div class="booking-select">
                            <input type="checkbox" class="booking-checkbox" data-booking-id="${booking.id}" onchange="updateDeleteButton()">
                        </div>
                        <div class="service-info">
                            <h3>${getServiceIcon(booking.service)} ${booking.service}</h3>
                            <span class="status-badge ${booking.status}">${booking.status.toUpperCase()}</span>
                        </div>
                        <div class="booking-amount">${booking.amount}</div>
                    </div>
                    
                    <div class="customer-info">
                        <div class="info-row">
                            <span class="label">Customer:</span>
                            <span class="value">${booking.customer}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Phone:</span>
                            <span class="value">${booking.phone}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Location:</span>
                            <span class="value">${booking.section} - ${booking.unit}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Quantity:</span>
                            <span class="value">${booking.quantity}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Date:</span>
                            <span class="value">${formatDate(booking.date)}</span>
                        </div>
                    </div>
                    
                    ${booking.status === 'pending' ? `
                        <div class="booking-actions">
                            <button onclick="markCompleted(${booking.id})" class="complete-btn">
                                ‚úÖ Mark Complete
                            </button>
                            <button onclick="deleteBooking('${booking.id}')" class="delete-single-btn">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    ` : `
                        <div class="booking-actions">
                            <button onclick="deleteBooking('${booking.id}')" class="delete-single-btn">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    `}
                </div>
            `).join('');
        }

        function getServiceIcon(service) {
            switch (service) {
                case 'Rotavation': return 'üöú';
                case 'Transport': return 'üöö';
                case 'Harvesting': return 'üåæ';
                default: return 'üîß';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function markCompleted(bookingId) {
            console.log('Mark completed called with ID:', bookingId, typeof bookingId);
            
            // Find the booking in our data - handle both string and number IDs
            const booking = bookingsData.find(b => b.id == bookingId || b.id === bookingId.toString());
            if (!booking) {
                console.error('Booking not found:', bookingId);
                console.log('Available bookings:', bookingsData.map(b => ({id: b.id, status: b.status})));
                alert('Error: Booking not found');
                return;
            }
            
            console.log('Found booking to complete:', booking);
            
            if (booking.status !== 'pending') {
                alert('This booking is not in pending status!');
                return;
            }

            // Get the booking card element for animation
            const bookingCard = document.querySelector(`button[onclick="markCompleted('${bookingId}')"]`)?.closest('.booking-card') ||
                               document.querySelector(`button[onclick="markCompleted(${bookingId})"]`)?.closest('.booking-card');
            const button = document.querySelector(`button[onclick="markCompleted('${bookingId}')"]`) ||
                          document.querySelector(`button[onclick="markCompleted(${bookingId})"]`);
            
            if (button && bookingCard) {
                // Step 1: Show processing state
                button.innerHTML = '‚è≥ Processing...';
                button.disabled = true;
                button.style.opacity = '0.7';
                button.style.cursor = 'not-allowed';
                
                // Step 2: Add completion animation to card
                bookingCard.style.transition = 'all 0.5s ease';
                bookingCard.style.transform = 'scale(1.02)';
                bookingCard.style.boxShadow = '0 8px 35px rgba(16, 185, 129, 0.3)';
                bookingCard.style.borderLeftColor = '#10b981';
                
                // Step 3: Show DONE tag temporarily
                const doneTag = document.createElement('div');
                doneTag.className = 'done-tag-animation';
                doneTag.innerHTML = '‚úÖ DONE';
                doneTag.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%) scale(0);
                    background: linear-gradient(135deg, #10b981, #059669);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 25px;
                    font-weight: 700;
                    font-size: 1.2rem;
                    z-index: 1000;
                    animation: doneAnimation 1.5s ease-out forwards;
                    box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4);
                `;
                bookingCard.style.position = 'relative';
                bookingCard.appendChild(doneTag);
            }

            // Update booking status in local data
            booking.status = 'completed';
            booking.completedAt = new Date().toISOString();
            console.log('Updated booking status locally:', booking);
            
            // Update in Firebase if available
            if (window.firebaseDB && window.firebaseDB.database) {
                const { database, ref, update } = window.firebaseDB;
                const updates = {};
                updates[`bookings/${bookingId}/status`] = 'completed';
                updates[`bookings/${bookingId}/completedAt`] = booking.completedAt;
                
                update(ref(database), updates)
                .then(() => {
                    console.log('Status updated in Firebase successfully');
                    setTimeout(() => completeTransition(bookingId, bookingCard), 1500);
                })
                .catch((error) => {
                    console.error('Error updating Firebase:', error);
                    setTimeout(() => completeTransition(bookingId, bookingCard), 1500);
                });
            } else {
                // Update localStorage if Firebase not available
                console.log('Firebase not available, using localStorage');
                localStorage.setItem('muchiri_bookings', JSON.stringify(bookingsData));
                setTimeout(() => completeTransition(bookingId, bookingCard), 1500);
            }
        }

        // Helper function to complete the transition
        function completeTransition(bookingId, bookingCard) {
            console.log('Completing transition for booking:', bookingId);
            
            // Remove the DONE tag
            if (bookingCard) {
                const doneTag = bookingCard.querySelector('.done-tag-animation');
                if (doneTag) {
                    doneTag.remove();
                }
                
                // Reset card styling
                bookingCard.style.transform = '';
                bookingCard.style.boxShadow = '';
                bookingCard.style.borderLeftColor = '';
            }
            
            // Force UI refresh
            console.log('Refreshing UI after completion');
            updateStats();
            renderBookings();
            
            // Show success message
            const completedBooking = bookingsData.find(b => b.id == bookingId);
            if (completedBooking) {
                showSuccessMessage(`üéâ ${completedBooking.service} service completed for ${completedBooking.customer}! Check the Completed tab.`);
            } else {
                showSuccessMessage('üéâ Service marked as completed! Check the Completed tab.');
            }
        }

        // Enhanced UI refresh function
        function refreshDashboardUI(completedBookingId) {
            // Update stats first
            updateStats();
            
            // Re-render all booking lists
            renderBookings();
            
            // Show success message with completed booking info
            const completedBooking = bookingsData.find(b => b.id === completedBookingId);
            if (completedBooking) {
                showSuccessMessage(`‚úÖ ${completedBooking.service} service completed for ${completedBooking.customer}!`);
            } else {
                showSuccessMessage('‚úÖ Service marked as completed!');
            }
            
            // If user is currently viewing pending tab, they'll see the item disappear
            // If viewing completed tab, they'll see the item appear with COMPLETED badge
            // If viewing all tab, they'll see the status change from PENDING to COMPLETED
        }

        // Enhanced success message function
        function showSuccessMessage(message) {
            // Remove any existing success message
            const existingMsg = document.querySelector('.success-message');
            if (existingMsg) {
                existingMsg.remove();
            }

            const successMsg = document.createElement('div');
            successMsg.className = 'success-message';
            successMsg.textContent = message;
            successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 15px 25px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3);
                z-index: 1000;
                font-weight: 500;
                font-size: 0.95rem;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            document.body.appendChild(successMsg);
            
            // Animate in
            setTimeout(() => {
                successMsg.style.transform = 'translateX(0)';
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                successMsg.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(successMsg)) {
                        document.body.removeChild(successMsg);
                    }
                }, 300);
            }, 3000);
        }

        function refreshBookings() {
            // Refresh data from Firebase or localStorage
            const refreshBtn = event.target;
            refreshBtn.textContent = 'üîÑ Refreshing...';
            refreshBtn.disabled = true;
            
            setTimeout(() => {
                loadBookingsData(); // Reload fresh data
                refreshBtn.textContent = 'üîÑ Refresh';
                refreshBtn.disabled = false;
            }, 1000);
        }

        // Delete functionality
        function deleteBooking(bookingId) {
            const booking = bookingsData.find(b => b.id == bookingId);
            if (!booking) return;
            
            const confirmMessage = `Are you sure you want to delete this booking?\n\nService: ${booking.service}\nCustomer: ${booking.customer}\nAmount: ${booking.amount}`;
            
            if (confirm(confirmMessage)) {
                performDeleteOperation([bookingId], `Deleted ${booking.service} booking for ${booking.customer}`);
            }
        }
        
        function selectAllInSection(sectionId) {
            const checkboxes = document.querySelectorAll(`#${sectionId} .booking-checkbox`);
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateDeleteButton();
        }
        
        function clearSelectionInSection(sectionId) {
            const checkboxes = document.querySelectorAll(`#${sectionId} .booking-checkbox`);
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateDeleteButton();
        }
        
        function updateDeleteButton() {
            // Update delete buttons for each section
            ['pendingBookings', 'completedBookings', 'allBookings'].forEach(sectionId => {
                const checkboxes = document.querySelectorAll(`#${sectionId} .booking-checkbox:checked`);
                const deleteBtn = document.querySelector(`button[onclick="deleteSelectedBookings('${sectionId}')"]`);
                if (deleteBtn) {
                    deleteBtn.disabled = checkboxes.length === 0;
                    deleteBtn.textContent = checkboxes.length > 0 ? `Delete Selected (${checkboxes.length})` : 'Delete Selected';
                }
            });
        }
        
        function deleteSelectedBookings(sectionId) {
            const checkboxes = document.querySelectorAll(`#${sectionId} .booking-checkbox:checked`);
            const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.bookingId);
            
            if (selectedIds.length === 0) return;
            
            const selectedBookings = bookingsData.filter(b => selectedIds.includes(b.id.toString()));
            const confirmMessage = `Are you sure you want to delete ${selectedIds.length} selected booking(s)?\n\n` +
                selectedBookings.map(b => `‚Ä¢ ${b.service} - ${b.customer} (${b.amount})`).join('\n');
            
            if (confirm(confirmMessage)) {
                performDeleteOperation(selectedIds, `Deleted ${selectedIds.length} booking(s) successfully`);
            }
        }
        
        function performDeleteOperation(bookingIds, successMessage) {
            // Remove from data array
            bookingsData = bookingsData.filter(booking => !bookingIds.includes(booking.id.toString()));
            
            // Update Firebase if available
            if (window.firebaseDB && window.firebaseDB.database) {
                const { database, ref, update } = window.firebaseDB;
                const updates = {};
                
                // Mark for deletion in Firebase (set to null removes the node)
                bookingIds.forEach(id => {
                    updates[`bookings/${id}`] = null;
                });
                
                update(ref(database), updates).then(() => {
                    console.log('Bookings deleted from Firebase successfully');
                }).catch((error) => {
                    console.error('Error deleting from Firebase:', error);
                });
            } else {
                // Update localStorage as fallback
                localStorage.setItem('muchiri_bookings', JSON.stringify(bookingsData));
            }
            
            // Update UI
            updateStats();
            renderBookings();
            
            // Show success message
            showDeleteSuccessMessage(successMessage);
        }
        
        function showDeleteSuccessMessage(message) {
            // Create success message element
            const successMsg = document.createElement('div');
            successMsg.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2em;">üóëÔ∏è</span>
                    <span>${message}</span>
                </div>
            `;
            successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #e53e3e, #c53030);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(229, 62, 62, 0.3);
                z-index: 1000;
                font-weight: 500;
                font-size: 0.95rem;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            document.body.appendChild(successMsg);
            
            // Animate in
            setTimeout(() => {
                successMsg.style.transform = 'translateX(0)';
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                successMsg.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(successMsg)) {
                        document.body.removeChild(successMsg);
                    }
                }, 300);
            }, 3000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            showPage('loginPage');
        });
    </script>
</body>
</html>
